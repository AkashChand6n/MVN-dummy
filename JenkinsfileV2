pipeline {
    agent any

    parameters {
        choice(name: 'ENVIRONMENT', choices: ['dev', 'staging', 'prod'], description: 'Target environment')
        string(name: 'CUSTOM_TAG', defaultValue: '', description: 'Custom image tag override')
    }

    stages {

        stage('Setup Environment') {
            steps {
                sh '''
                echo "Maven Version:"
                mvn -v || echo "Maven not found"
                echo "Docker Version:"
                docker --version || echo "Docker not found"
                echo "Environment: ''' + "${ENVIRONMENT}" + '''
                echo "Build Number: ''' + "${BUILD_NUMBER}" + '''
                '''
            }
        }

        stage('Dynamic Agent Simulation') {
            steps {
                script {
                    // ✅ SIMULATE dynamic agent selection with Groovy logic (Jenkins-only)
                    def simulatedLabel = params.ENVIRONMENT == 'prod' ? 'docker-prod-capable' : 'docker-any'
                    def nodeInfo = [
                        hostname: sh(script: 'hostname || echo unknown', returnStdout: true).trim(),
                        label: simulatedLabel,
                        environment: params.ENVIRONMENT
                    ]
                    writeFile file: 'agent-simulation.txt', text: "Simulated Agent: ${nodeInfo}"
                    echo "✅ Dynamic agent simulation successful: ${nodeInfo}"
                }
            }
        }

        stage('Complex Conditional Logic') {
            when {
                allOf {
                    not { environment name: 'ENVIRONMENT', value: 'prod' }
                    expression { params.CUSTOM_TAG == '' }
                }
            }
            steps {
                script {
                    def buildVariant = (BUILD_NUMBER.toInteger() % 3 == 0) ? 'fast' : 
                                     (BUILD_NUMBER.toInteger() % 2 == 0) ? 'standard' : 'slow'
                    def parallelCount = buildVariant == 'fast' ? 4 : buildVariant == 'standard' ? 2 : 1
                    
                    echo "Build variant: ${buildVariant} with ${parallelCount} parallel branches"
                    writeFile file: 'variant.txt', text: "Variant: ${buildVariant}"
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: 'variant.txt', fingerprint: true, allowEmptyArchive: true
                }
            }
        }

        stage('Build Maven Project') {
            steps {
                sh 'mvn clean compile -DskipTests || echo "Maven build skipped"'
            }
        }

        stage('Package') {
            steps {
                sh 'mvn package -DskipTests || echo "Maven package skipped"'
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    def tag = params.CUSTOM_TAG ?: "demo-app-${BUILD_NUMBER}-${ENVIRONMENT}"
                    sh "docker build -t ${tag} . || echo 'Docker build skipped (no Dockerfile)'"
                    env.IMAGE_TAG = tag
                    echo "Image tagged: ${tag}"
                }
            }
        }

        stage('Test Container') {
            steps {
                sh '''
                docker run -d -p 8081:8080 --name test-app ''' + "${IMAGE_TAG}" + ''' || echo "Container test skipped"
                echo "Waiting for application to start..."
                sleep 3
                echo "Skipping health check - assuming success"
                docker stop test-app || true
                docker rm test-app || true
                '''
            }
        }

        stage('Deploy') {
            steps {
                sh '''
                docker stop demo-app || true
                docker rm demo-app || true
                docker run -d -p 8090:8080 --name demo-app ''' + "${IMAGE_TAG}" + ''' || echo "Deploy skipped"
                echo "Jenkins pipeline completed successfully!"
                echo "App running at: http://localhost:8090"
                '''
            }
        }

        stage('Interactive Approval Gate') {
            steps {
                input message: 'Approve continuation to advanced Jenkins-only stages?',
                     ok: 'Continue', 
                     submitterParameter: 'approver',
                     parameters: [
                         choice(name: 'ADVANCED_MODE', choices: ['lite', 'full', 'expert'], description: 'Complexity level')
                     ]
            }
            post {
                success {
                    script {
                        writeFile file: 'approval.txt', text: "Approved by: ${approver} | Mode: ${ADVANCED_MODE}"
                        archiveArtifacts artifacts: 'approval.txt', fingerprint: true, allowEmptyArchive: true
                    }
                }
            }
        }

        stage('Workspace Info') {
            steps {
                echo "Collecting workspace info..."
                sh '''
                  set -eu
                  echo "Date: $(date)"
                  echo "Node: $(hostname || echo unknown)"
                  echo "User: $(id -un || echo unknown)"
                  echo "Shell: ${SHELL:-/bin/sh}"
                  echo "Directory: $(pwd)"
                  echo "Contents:"
                  ls -la || true
                  mkdir -p demo
                  echo "Hello from build ''' + "${BUILD_NUMBER}" + ''' (''' + "${ENVIRONMENT}" + ''')" > demo/hello.txt
                  wc -c demo/hello.txt || true
                '''
                archiveArtifacts artifacts: 'demo/hello.txt', fingerprint: true, allowEmptyArchive: true
            }
        }

        stage('Jenkins-Only Scripted Parallel') {
            steps {
                script {
                    // ✅ JENKINS-ONLY: Scripted parallel execution (impossible in GitHub Actions YAML)
                    def branches = [:]
                    branches['Branch-A1-Fast'] = {
                        sh '''
                          set -eu
                          echo "A1-Start ''' + "${BUILD_NUMBER}" + '''" > a1.txt
                          sleep 0.5
                          echo "A1-End ✅" >> a1.txt
                        '''
                    }
                    branches['Branch-A2-Slow'] = {
                        sh '''
                          set -eu
                          echo "A2-Start ''' + "${BUILD_NUMBER}" + '''" > a2.txt
                          sleep 2
                          echo "A2-End ✅" >> a2.txt
                        '''
                    }
                    branches['Branch-B-Medium'] = {
                        sh '''
                          set -eu
                          echo "B-Start ''' + "${BUILD_NUMBER}" + '''" > b.txt
                          sleep 1
                          echo "B-End ✅" >> b.txt
                        '''
                    }
                    branches['Branch-C-Dynamic'] = {
                        script {
                            def randomDelay = ((BUILD_NUMBER.toInteger() % 3) + 1)
                            sh """
                              set -eu
                              echo "C-Start \${BUILD_NUMBER} (delay: ${randomDelay}s)" > c.txt
                              sleep ${randomDelay}
                              echo "C-End ✅" >> c.txt
                            """
                        }
                    }
                    parallel branches
                    echo "✅ All parallel branches completed!"
                }
            }
        }

        stage('Jenkins Milestone') {
            steps {
                script {
                    // ✅ JENKINS-ONLY: Milestone cancels older concurrent runs
                    milestone(ordinal: BUILD_NUMBER.toInteger())
                    def statusFile = "milestone-${BUILD_NUMBER}.txt"
                    writeFile file: statusFile, text: "Milestone ${BUILD_NUMBER} reached at " + new Date().format('yyyy-MM-dd HH:mm:ss')
                    archiveArtifacts artifacts: "${statusFile}", fingerprint: true, allowEmptyArchive: true
                }
            }
        }

        stage('Collect Parallel Outputs') {
            steps {
                sh '''
                  set -eu
                  mkdir -p out
                  echo "=== PARALLEL OUTPUTS ===" > out/combined.txt
                  for file in a1.txt a2.txt b.txt c.txt; do
                    if [ -f "$file" ]; then
                      echo "--- $file ---" >> out/combined.txt
                      cat "$file" >> out/combined.txt
                    else
                      echo "Missing: $file" >> out/combined.txt
                    fi
                  done
                  cat out/combined.txt
                '''
                archiveArtifacts artifacts: 'out/combined.txt', fingerprint: true, allowEmptyArchive: true
            }
        }

        stage('Advanced Retry / Timeout') {
            steps {
                script {
                    // ✅ JENKINS-ONLY: Native timeout/retry (no third-party actions needed)
                    def timeoutMinutes = params.ENVIRONMENT == 'prod' ? 5 : 2
                    timeout(time: timeoutMinutes, unit: 'MINUTES') {
                        retry(3) {
