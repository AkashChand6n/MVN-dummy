pipeline {
    agent any

    parameters {
        choice(name: 'ENVIRONMENT', choices: ['dev', 'staging', 'prod'], description: 'Target environment')
        string(name: 'CUSTOM_TAG', defaultValue: '', description: 'Custom image tag override')
    }

    stages {

        stage('Setup Environment') {
            steps {
                sh '''
                    echo "Maven Version:"
                    mvn -v || echo "Maven not found"
                    echo "Docker Version:"
                    docker --version || echo "Docker not found"
                    echo "Environment: ''' + "${ENVIRONMENT}" + '''"
                    echo "Build Number: ''' + "${BUILD_NUMBER}" + '''"
                '''
            }
        }

        stage('Dynamic Agent Simulation') {
            steps {
                script {
                    def simulatedLabel = params.ENVIRONMENT == 'prod' ? 'docker-prod-capable' : 'docker-any'
                    def nodeInfo = [
                        hostname: sh(script: 'hostname || echo unknown', returnStdout: true).trim(),
                        label: simulatedLabel,
                        environment: params.ENVIRONMENT
                    ]
                    writeFile file: 'agent-simulation.txt', text: "Simulated Agent: ${nodeInfo}"
                    echo "Dynamic agent simulation: ${nodeInfo}"
                }
            }
        }

        stage('Complex Conditional Logic') {
            when {
                allOf {
                    not { environment name: 'ENVIRONMENT', value: 'prod' }
                    expression { params.CUSTOM_TAG == '' }
                }
            }
            steps {
                script {
                    def buildVariant = (BUILD_NUMBER.toInteger() % 3 == 0) ? 'fast' : 
                                     (BUILD_NUMBER.toInteger() % 2 == 0) ? 'standard' : 'slow'
                    writeFile file: 'variant.txt', text: "Variant: ${buildVariant}"
                    echo "Build variant: ${buildVariant}"
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: 'variant.txt', allowEmptyArchive: true
                }
            }
        }

        stage('Build Maven Project') {
            steps {
                sh 'mvn clean compile -DskipTests || echo "Maven build skipped"'
            }
        }

        stage('Package') {
            steps {
                sh 'mvn package -DskipTests || echo "Maven package skipped"'
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    def tag = params.CUSTOM_TAG ?: "demo-app-${BUILD_NUMBER}-${ENVIRONMENT}"
                    env.IMAGE_TAG = tag
                    sh "docker build -t ${tag} . || echo 'Docker build skipped'"
                    echo "Image tagged: ${tag}"
                }
            }
        }

        stage('Test Container') {
            steps {
                sh '''
                    docker run -d -p 8081:8080 --name test-app ''' + "${IMAGE_TAG}" + ''' || echo "Container test skipped"
                    sleep 3
                    docker stop test-app || true
                    docker rm test-app || true
                '''
            }
        }

        stage('Deploy') {
            steps {
                sh '''
                    docker stop demo-app || true
                    docker rm demo-app || true
                    docker run -d -p 8090:8080 --name demo-app ''' + "${IMAGE_TAG}" + ''' || echo "Deploy skipped"
                    echo "App running at: http://localhost:8090"
                '''
            }
        }

        stage('Interactive Approval Gate') {
            steps {
                input message: 'Approve advanced Jenkins-only stages?',
                     ok: 'Continue',
                     submitterParameter: 'approver',
                     parameters: [
                         choice(name: 'ADVANCED_MODE', choices: ['lite', 'full', 'expert'], description: 'Complexity level')
                     ]
            }
        }

        stage('Workspace Info') {
            steps {
                sh '''
                    echo "Date: $(date)"
                    echo "Node: $(hostname)"
                    echo "User: $(id -un)"
                    echo "Directory: $(pwd)"
                    ls -la || true
                    mkdir -p demo
                    echo "Hello build ''' + "${BUILD_NUMBER}" + ''' (''' + "${ENVIRONMENT}" + ''')" > demo/hello.txt
                '''
                archiveArtifacts artifacts: 'demo/hello.txt', allowEmptyArchive: true
            }
        }

        stage('Jenkins Scripted Parallel') {
            steps {
                script {
                    def branches = [:]
                    branches['A-Fast'] = {
                        sh 'echo "A-Start ' + "${BUILD_NUMBER}" + '" > a.txt && sleep 0.5 && echo "A-End" >> a.txt'
                    }
                    branches['B-Slow'] = {
                        sh 'echo "B-Start ' + "${BUILD_NUMBER}" + '" > b.txt && sleep 2 && echo "B-End" >> b.txt'
                    }
                    branches['C-Dynamic'] = {
                        def delay = (BUILD_NUMBER.toInteger() % 3) + 1
                        sh "echo \"C-Start ${BUILD_NUMBER} (delay:${delay}s)\" > c.txt && sleep ${delay} && echo \"C-End\" >> c.txt"
                    }
                    parallel branches
                }
            }
        }

        stage('Jenkins Milestone') {
            steps {
                script {
                    milestone(BUILD_NUMBER.toInteger())
                    writeFile file: "milestone-${BUILD_NUMBER}.txt", 
                        text: "Milestone ${BUILD_NUMBER} at " + new Date().format('yyyy-MM-dd HH:mm:ss')
                }
                archiveArtifacts artifacts: 'milestone-*.txt', allowEmptyArchive: true
            }
        }

        stage('Collect Outputs') {
            steps {
                sh '''
                    mkdir -p out
                    echo "=== PARALLEL RESULTS ===" > out/combined.txt
                    for f in a.txt b.txt c.txt; do
                        [ -f "$f" ] && { echo "--- $f ---" >> out/combined.txt; cat "$f" >> out/combined.txt; } || echo "Missing $f" >> out/combined.txt
                    done
                '''
                archiveArtifacts artifacts: 'out/combined.txt', allowEmptyArchive: true
            }
        }

        stage('Advanced Retry Timeout') {
            steps {
                script {
                    def timeoutMins = params.ENVIRONMENT == 'prod' ? 5 : 2
                    timeout(time: timeoutMins, unit: 'MINUTES') {
                        retry(3) {
                            sh '''
                                FLAKE=30
                                if [ $((RANDOM % 100)) -lt $FLAKE ]; then
                                    echo "Simulated failure"
                                    exit 1
                                else
                                    echo "Success!"
                                fi
                            '''
                        }
                    }
                }
            }
        }

        stage('Complex Stash Demo') {
            steps {
                sh '''
                    mkdir -p stashdir1 stashdir2
                    echo "data1-''' + "${BUILD_NUMBER}" + '''" > stashdir1/data1.txt
                    echo "data2-''' + "${BUILD_NUMBER}" + '''" > stashdir2/data2.txt
                '''
                stash name: 'ws1', includes: 'stashdir1/**'
                stash name: 'ws2', includes: 'stashdir2/**'
                deleteDir()
                unstash 'ws1'
                unstash 'ws2'
                sh 'ls -la stashdir*'
                archiveArtifacts artifacts: 'stashdir*/*.txt', allowEmptyArchive: true
            }
        }

        stage('Stage Post Demo') {
            steps {
                sh '''
                    mkdir -p stage-post
                    echo "Stage demo BUILD_NUMBER: ''' + "${BUILD_NUMBER}" + '''" > stage-post/demo.txt
                '''
            }
            post {
                always {
                    archiveArtifacts artifacts: 'stage-post/demo.txt', allowEmptyArchive: true
                }
            }
        }

        stage('Groovy Dynamic') {
            steps {
                script {
                    def info = [
                        build: "${BUILD_NUMBER}",
                        env: "${ENVIRONMENT}",
                        time: new Date().format('yyyy-MM-dd HH:mm:ss')
                    ]
                    writeFile file: 'groovy.json', text: groovy.json.JsonOutput.toJson(info)
                    
                    def stages = [:]
                    (1..2).each { i ->
                        stages["Dyn-${i}"] = { sh "echo 'Dynamic ${i}' > dyn-${i}.txt" }
                    }
                    parallel stages
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: 'groovy.json dyn-*.txt', allowEmptyArchive: true
                }
            }
        }

        stage('Final Report') {
            steps {
                sh '''
                    mkdir -p summary
                    {
                        echo "PIPELINE SUMMARY"
                        echo "Build: ''' + "${BUILD_NUMBER}" + ''' Env: ''' + "${ENVIRONMENT}" + '''"
                        echo "Generated files:"
                        find . -name "*.txt" -o -name "*.json" 2>/dev/null | head -10
                    } > summary/report.txt
                '''
                archiveArtifacts artifacts: 'summary/report.txt', allowEmptyArchive: true
            }
        }
    }

    post {
        always {
            sh '''
                docker stop demo-app test-app || true
                docker rm demo-app test-app || true
                docker rmi demo-app:* || true
            '''
        }
        success {
            echo "SUCCESS - All Jenkins features demonstrated!"
        }
        failure {
            echo "FAILURE - Check logs"
        }
    }
}
